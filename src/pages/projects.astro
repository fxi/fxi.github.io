---
import Layout from '../layouts/Layout.astro';
import fs from 'node:fs';
import path from 'node:path';

// Major / professional projects (not in projects/ directory)
const majorProjects = [
  {
    name: "mapx",
    description: "UN-endorsed platform transforming geospatial data visualization for global sustainability",
    tags: ["Node.js", "PostgreSQL", "Redis", "Microservices"],
    url: "https://app.mapx.org",
    source: "https://github.com/unep-grid/mapx",
    featured: true,
  },
  {
    name: "accessmod",
    description: "WHO-certified Digital Public Good for healthcare accessibility analysis",
    tags: ["R", "Shiny", "GRASS GIS", "Spatial Analysis"],
    url: "https://www.accessmod.org",
    source: "https://github.com/unige-geohealth/accessmod",
    featured: true,
  }
];

// Load project.json files from the projects directory
const projectsDir = path.resolve('..', 'projects');
const projectDirs = fs.readdirSync(projectsDir, { withFileTypes: true })
  .filter(d => d.isDirectory())
  .map(d => d.name);

const sideProjects = projectDirs
  .map(dir => {
    const jsonPath = path.join(projectsDir, dir, 'project.json');
    if (!fs.existsSync(jsonPath)) return null;
    try {
      return JSON.parse(fs.readFileSync(jsonPath, 'utf-8'));
    } catch {
      return null;
    }
  })
  .filter(Boolean)
  .sort((a, b) => (b.year_last || 0) - (a.year_last || 0));

const allProjects = [...majorProjects, ...sideProjects];
const featured = allProjects.filter(p => p.featured);
const others = allProjects.filter(p => !p.featured);
---

<Layout title="Projects - Frédéric Moser">
  <h1>Projects</h1>

  {featured.length > 0 && (
    <section class="mb-12">
      <h2 class="text-xl font-semibold mb-6 text-zinc-800 dark:text-zinc-200">Featured</h2>
      <div class="space-y-8">
        {featured.map(project => (
          <article class="card">
            <h3 class="mb-2 text-lg font-medium">{project.name}</h3>
            <p class="text-zinc-600 dark:text-zinc-400">{project.description}</p>
            <div class="mt-4 flex flex-wrap gap-2">
              {project.tags.map(tag => (
                <span class="px-2 py-1 text-sm rounded-md bg-zinc-100 dark:bg-zinc-800 text-zinc-700 dark:text-zinc-300">
                  {tag}
                </span>
              ))}
            </div>
            <div class="mt-4 flex gap-4">
              {project.source && (
                <a href={project.source} class="text-sm text-zinc-600 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100">
                  Source →
                </a>
              )}
              {project.url && (
                <a href={project.url} class="text-sm text-zinc-600 dark:text-zinc-400 hover:text-zinc-900 dark:hover:text-zinc-100">
                  Demo →
                </a>
              )}
            </div>
          </article>
        ))}
      </div>
    </section>
  )}

  <section>
    <h2 class="text-xl font-semibold mb-6 text-zinc-800 dark:text-zinc-200">Side Projects</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      {others.map(project => (
        <article class="card p-4">
          <div class="flex justify-between items-start">
            <h3 class="font-medium">{project.name}</h3>
            {(project.year_init || project.year_last) && (
              <span class="text-xs text-zinc-500 dark:text-zinc-500">
                {project.year_init === project.year_last ? project.year_init : `${project.year_init}–${project.year_last}`}
              </span>
            )}
          </div>
          <p class="text-sm text-zinc-600 dark:text-zinc-400 mt-1">{project.description}</p>
          <div class="mt-3 flex flex-wrap gap-1">
            {project.tags.map(tag => (
              <span class="px-1.5 py-0.5 text-xs rounded bg-zinc-100 dark:bg-zinc-800 text-zinc-600 dark:text-zinc-400">
                {tag}
              </span>
            ))}
          </div>
          <div class="mt-3 flex gap-3">
            {project.url && (
              <a href={project.url} class="text-xs text-zinc-500 hover:text-zinc-800 dark:hover:text-zinc-200">
                Demo →
              </a>
            )}
            <a href={`https://github.com/fxi/${project.name}`} class="text-xs text-zinc-500 hover:text-zinc-800 dark:hover:text-zinc-200">
              Source →
            </a>
          </div>
        </article>
      ))}
    </div>
  </section>
</Layout>
